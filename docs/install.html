<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Install vibeCheck</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 40px 20px;
      background: #0d1117;
      color: #c9d1d9;
      min-height: 100vh;
    }
    h1 {
      color: #58a6ff;
      margin-bottom: 8px;
    }
    .subtitle {
      color: #8b949e;
      margin-bottom: 32px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #30363d;
      border-radius: 6px;
      background: #161b22;
      color: #c9d1d9;
      margin-bottom: 16px;
    }
    input:focus {
      outline: none;
      border-color: #58a6ff;
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
    }
    input::placeholder {
      color: #6e7681;
    }
    button {
      width: 100%;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      background: #238636;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #2ea043;
    }
    button:disabled {
      background: #21262d;
      color: #6e7681;
      cursor: not-allowed;
    }
    .help {
      margin-top: 24px;
      padding: 16px;
      background: #161b22;
      border-radius: 6px;
      border: 1px solid #30363d;
    }
    .help h3 {
      margin-top: 0;
      color: #8b949e;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .help p {
      margin: 0;
      color: #8b949e;
      font-size: 14px;
      line-height: 1.5;
    }
    .help code {
      background: #0d1117;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
    }
    a {
      color: #58a6ff;
    }
    .logo {
      font-size: 32px;
      font-weight: 700;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #238636 0%, #2ea043 100%);
      border-radius: 12px;
      margin-bottom: 16px;
      color: #fff;
      box-shadow: 0 4px 12px rgba(35, 134, 54, 0.3);
    }
    .error {
      color: #f85149;
      font-size: 14px;
      margin-top: -12px;
      margin-bottom: 16px;
      display: none;
    }
    .error.show {
      display: block;
    }

    /* Advanced Options Styles */
    details {
      margin-top: 8px;
      border: 1px solid #30363d;
      border-radius: 8px;
      background: #161b22;
    }
    summary {
      padding: 14px 16px;
      cursor: pointer;
      font-weight: 600;
      color: #c9d1d9;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #1c2128;
      border-bottom: 1px solid transparent;
      transition: background 0.15s;
    }
    summary:hover {
      background: #21262d;
    }
    details[open] summary {
      border-bottom-color: #30363d;
    }
    summary::marker {
      color: #58a6ff;
    }
    summary::before {
      content: "⚙️";
      font-size: 14px;
    }
    .options-content {
      padding: 20px;
    }
    .option-group {
      margin-bottom: 28px;
      padding-bottom: 24px;
      border-bottom: 1px solid #21262d;
    }
    .option-group:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .option-group h4 {
      margin: 0 0 16px 0;
      color: #c9d1d9;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .option-group h4::before {
      content: "";
      width: 3px;
      height: 14px;
      background: #58a6ff;
      border-radius: 2px;
    }
    .option-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }
    .option-field {
      min-width: 0;
    }
    .option-field label {
      display: block;
      margin-bottom: 6px;
      font-size: 12px;
      color: #8b949e;
      font-weight: 500;
    }
    .option-field select,
    .option-field input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid #30363d;
      border-radius: 6px;
      background: #0d1117;
      color: #c9d1d9;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .option-field select:focus,
    .option-field input[type="number"]:focus {
      outline: none;
      border-color: #58a6ff;
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
    }
    .option-field select:hover,
    .option-field input[type="number"]:hover {
      border-color: #484f58;
    }

    /* Tool Selection */
    .tool-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .tool-category {
      flex: 0 1 calc(50% - 6px);
      min-width: 220px;
      background: #0d1117;
      border-radius: 8px;
      padding: 10px;
      border: 1px solid #21262d;
    }
    .tool-grid {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .tool-category-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #30363d;
    }
    .tool-category-header .lang-badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
    }
    .tool-category-header .lang-badge.universal {
      background: linear-gradient(135deg, #238636 0%, #2ea043 100%);
      color: #fff;
    }
    .tool-category-header .lang-badge.js {
      background: linear-gradient(135deg, #f0db4f 0%, #e0cb3f 100%);
      color: #323330;
    }
    .tool-category-header .lang-badge.python {
      background: linear-gradient(135deg, #3776ab 0%, #4a8fc2 100%);
      color: #fff;
    }
    .tool-category-header .lang-badge.java {
      background: linear-gradient(135deg, #e76f00 0%, #f89820 100%);
      color: #fff;
    }
    .tool-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: background 0.15s, border-color 0.15s;
    }
    .tool-item:hover {
      background: #161b22;
      border-color: #30363d;
    }
    .tool-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin: 0;
      accent-color: #58a6ff;
      cursor: pointer;
      flex-shrink: 0;
    }
    .tool-item .tool-info {
      flex: 1;
      min-width: 0;
    }
    .tool-item .tool-name {
      font-size: 13px;
      color: #c9d1d9;
      font-weight: 500;
    }
    .tool-item .tool-desc {
      font-size: 11px;
      color: #6e7681;
      margin-top: 2px;
    }
    /* Responsive adjustments for smaller screens */
    @media (max-width: 500px) {
      .option-row {
        grid-template-columns: 1fr;
      }
      .tool-categories {
        grid-template-columns: 1fr;
      }
    }

    /* Summary indicator for customization */
    .custom-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #58a6ff;
      margin-left: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .custom-indicator.show {
      opacity: 1;
    }

    /* Info tooltip */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #30363d;
      color: #8b949e;
      font-size: 10px;
      font-weight: 600;
      cursor: help;
      margin-left: 4px;
      position: relative;
      vertical-align: middle;
    }
    .info-icon:hover {
      background: #484f58;
      color: #c9d1d9;
    }
    .info-icon .tooltip {
      display: none;
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: #1c2128;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 400;
      color: #c9d1d9;
      white-space: normal;
      width: max-content;
      max-width: 220px;
      text-align: center;
      line-height: 1.4;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .info-icon .tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #30363d;
    }
    .info-icon:hover .tooltip {
      display: block;
    }

    /* Button group */
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    .button-group button {
      flex: 1;
    }
    .button-group button.secondary {
      background: #21262d;
      border: 1px solid #30363d;
    }
    .button-group button.secondary:hover {
      background: #30363d;
    }

    /* Copy notice */
    .copy-notice {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #238636;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
      z-index: 1000;
    }
    .copy-notice.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="logo">✓</div>
  <h1>Install vibeCheck</h1>
  <p class="subtitle">Add automated code analysis to your repository in one click</p>

  <form id="installForm">
    <label for="repo">Repository (owner/repo or GitHub URL)</label>
    <input
      type="text"
      id="repo"
      name="repo"
      placeholder="e.g., octocat/my-project or https://github.com/octocat/my-project"
      required
    >
    <p class="error" id="error">Please enter a valid repository (owner/repo or GitHub URL)</p>

    <details id="advancedOptions">
      <summary>Advanced Options <span class="custom-indicator" id="customIndicator" title="Custom settings applied"></span></summary>
      <div class="options-content">
        <!-- Analysis Settings -->
        <div class="option-group">
          <h4>Analysis Settings</h4>
          <div class="option-row">
            <div class="option-field">
              <label for="cadence">Schedule <span class="info-icon">i<span class="tooltip">How often to run analysis automatically</span></span></label>
              <select id="cadence">
                <option value="manual" selected>Manual (default)</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
            <div class="option-field">
              <label for="severity">Min Severity <span class="info-icon">i<span class="tooltip">Only report issues at or above this level</span></span></label>
              <select id="severity">
                <option value="info">Info</option>
                <option value="low" selected>Low (default)</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
              </select>
            </div>
            <div class="option-field">
              <label for="confidence">Min Confidence <span class="info-icon">i<span class="tooltip">Higher = fewer false positives, lower = more findings</span></span></label>
              <select id="confidence">
                <option value="low">Low</option>
                <option value="medium" selected>Medium (default)</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>
          <div style="margin-top: 16px;">
            <label class="tool-item" style="background: #0d1117; border: 1px solid #30363d; border-radius: 6px;">
              <input type="checkbox" id="autofixPrs" name="autofixPrs">
              <div class="tool-info">
                <div class="tool-name">Create Autofix PRs <span class="info-icon">i<span class="tooltip">Automatically create PRs for safe fixes (ESLint formatting, Ruff style). Requires additional permissions.</span></span></div>
                <div class="tool-desc">Auto-create PRs for safe formatting fixes</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Tool Selection -->
        <div class="option-group">
          <h4>Tools</h4>
          <div class="tool-categories">

          <!-- Universal Tools -->
          <div class="tool-category">
            <div class="tool-category-header">
              <span class="lang-badge universal">Universal</span>
            </div>
            <div class="tool-grid">
              <label class="tool-item">
                <input type="checkbox" name="tool" value="trunk" checked data-category="universal">
                <div class="tool-info">
                  <div class="tool-name">Trunk</div>
                  <div class="tool-desc">ESLint, Prettier, and more</div>
                </div>
              </label>
              <label class="tool-item">
                <input type="checkbox" name="tool" value="semgrep" checked data-category="universal">
                <div class="tool-info">
                  <div class="tool-name">Semgrep</div>
                  <div class="tool-desc">Security scanning</div>
                </div>
              </label>
              <label class="tool-item">
                <input type="checkbox" name="tool" value="jscpd" checked data-category="universal">
                <div class="tool-info">
                  <div class="tool-name">jscpd</div>
                  <div class="tool-desc">Copy-paste detection</div>
                </div>
              </label>
            </div>
          </div>

          <!-- JavaScript/TypeScript Tools -->
          <div class="tool-category">
            <div class="tool-category-header">
              <span class="lang-badge js">JavaScript / TypeScript</span>
            </div>
            <div class="tool-grid">
              <label class="tool-item">
                <input type="checkbox" name="tool" value="tsc" checked data-category="js">
                <div class="tool-info">
                  <div class="tool-name">TypeScript</div>
                  <div class="tool-desc">Type checking</div>
                </div>
              </label>
              <label class="tool-item">
                <input type="checkbox" name="tool" value="dependency-cruiser" checked data-category="js">
                <div class="tool-info">
                  <div class="tool-name">dependency-cruiser</div>
                  <div class="tool-desc">Circular dependencies</div>
                </div>
              </label>
              <label class="tool-item">
                <input type="checkbox" name="tool" value="knip" checked data-category="js">
                <div class="tool-info">
                  <div class="tool-name">Knip</div>
                  <div class="tool-desc">Dead code detection</div>
                </div>
              </label>
            </div>
          </div>

          <!-- Python Tools -->
          <div class="tool-category">
            <div class="tool-category-header">
              <span class="lang-badge python">Python</span>
            </div>
            <div class="tool-grid">
              <label class="tool-item">
                <input type="checkbox" name="tool" value="ruff" checked data-category="python">
                <div class="tool-info">
                  <div class="tool-name">Ruff</div>
                  <div class="tool-desc">Fast Python linter</div>
                </div>
              </label>
              <label class="tool-item">
                <input type="checkbox" name="tool" value="mypy" checked data-category="python">
                <div class="tool-info">
                  <div class="tool-name">Mypy</div>
                  <div class="tool-desc">Type checking</div>
                </div>
              </label>
              <label class="tool-item">
                <input type="checkbox" name="tool" value="bandit" checked data-category="python">
                <div class="tool-info">
                  <div class="tool-name">Bandit</div>
                  <div class="tool-desc">Security scanning</div>
                </div>
              </label>
            </div>
          </div>

          <!-- Java Tools -->
          <div class="tool-category">
            <div class="tool-category-header">
              <span class="lang-badge java">Java</span>
            </div>
            <div class="tool-grid">
              <label class="tool-item">
                <input type="checkbox" name="tool" value="pmd" checked data-category="java">
                <div class="tool-info">
                  <div class="tool-name">PMD</div>
                  <div class="tool-desc">Code analysis</div>
                </div>
              </label>
              <label class="tool-item">
                <input type="checkbox" name="tool" value="spotbugs" checked data-category="java">
                <div class="tool-info">
                  <div class="tool-name">SpotBugs</div>
                  <div class="tool-desc">Bug detection</div>
                </div>
              </label>
            </div>
          </div>

          </div>
        </div>
      </div>
    </details>

    <div class="button-group">
      <button type="submit" id="submitBtn">Add to repository</button>
      <button type="button" id="updateBtn" class="secondary">Update existing workflow</button>
    </div>
  </form>

  <div id="copyNotice" class="copy-notice">
    Workflow YAML copied! Paste it in the editor that just opened.
  </div>

  <div class="help">
    <h3>What happens next?</h3>
    <p>
      You'll be taken to GitHub to create a new file in your repository.
      The workflow file will be pre-filled - just click <strong>"Commit changes"</strong> to add vibeCheck.
    </p>
  </div>

  <div class="help" style="margin-top: 16px;">
    <h3>What does vibeCheck do?</h3>
    <p>
      Runs static analysis tools (ESLint, TypeScript, Semgrep, etc.) and creates GitHub issues
      that AI coding agents can automatically fix.
      <a href="https://github.com/WolffM/vibecheck" target="_blank">Learn more →</a>
    </p>
  </div>

  <script>
    // Default values
    const DEFAULTS = {
      cadence: 'manual',
      severity: 'low',
      confidence: 'medium',
      autofixPrs: false
    };

    // All tools that are enabled by default
    const DEFAULT_TOOLS = ['trunk', 'semgrep', 'jscpd', 'tsc', 'dependency-cruiser', 'knip', 'ruff', 'mypy', 'bandit', 'pmd', 'spotbugs'];

    // Get cron expression for cadence
    function getCronForCadence(cadence) {
      switch (cadence) {
        case 'daily': return '0 3 * * *';      // Every day at 3am UTC
        case 'weekly': return '0 3 * * 1';     // Monday at 3am UTC
        case 'monthly': return '0 3 1 * *';    // 1st of month at 3am UTC
        default: return null;  // manual - no schedule
      }
    }

    // Generate workflow YAML based on options
    function generateWorkflow(options) {
      const { cadence, severity, confidence, disabledTools, autofixPrs } = options;
      const cron = getCronForCadence(cadence);

      // Check if using non-default values
      const isCustom =
        cadence !== DEFAULTS.cadence ||
        severity !== DEFAULTS.severity ||
        confidence !== DEFAULTS.confidence ||
        disabledTools.length > 0 ||
        autofixPrs;

      // Build the on: section based on cadence
      let onSection;
      if (cron) {
        const cadenceComment = cadence === 'weekly' ? 'on Monday ' : cadence === 'monthly' ? 'on the 1st ' : '';
        onSection = `on:
  # Run ${cadence} ${cadenceComment}at 3am UTC
  schedule:
    - cron: "${cron}"

  # Allow manual trigger
  workflow_dispatch:`;
      } else {
        onSection = `on:
  # Manual trigger only - run via Actions tab
  workflow_dispatch:`;
      }

      // Build permissions section - add write permissions if autofix is enabled
      let permissionsSection;
      if (autofixPrs) {
        permissionsSection = `permissions:
  contents: write      # Required for autofix PRs
  issues: write
  pull-requests: write # Required for autofix PRs
  security-events: write`;
      } else {
        permissionsSection = `permissions:
  contents: read
  issues: write
  security-events: write`;
      }

      // Build the workflow
      let yaml = `# vibeCheck Workflow
#
# This workflow runs vibeCheck static analysis on your repository.
# For more info: https://github.com/WolffM/vibecheck

name: vibeCheck

${onSection}

${permissionsSection}

jobs:
  analyze:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run vibeCheck
        uses: WolffM/vibecheck@main
        with:
          github_token: \${{ secrets.GITHUB_TOKEN }}`;

      // Add custom options only if they differ from defaults
      if (severity !== 'info') {
        yaml += `\n          severity_threshold: "${severity}"`;
      }
      if (confidence !== 'low') {
        yaml += `\n          confidence_threshold: "${confidence}"`;
      }

      // Add autofix_prs if enabled
      if (autofixPrs) {
        yaml += `\n          autofix_prs: true`;
      }

      // If tools are disabled, we need a config file
      // For now, add a comment about it
      if (disabledTools.length > 0) {
        yaml += `\n          # Note: Some tools disabled. Create vibecheck.yml to customize:`;
        yaml += `\n          # tools:`;
        for (const tool of disabledTools) {
          const configKey = tool === 'dependency-cruiser' ? 'dependency_cruiser' : tool;
          yaml += `\n          #   ${configKey}: { enabled: false }`;
        }
      }

      yaml += '\n';
      return yaml;
    }

    // Get current form options
    function getOptions() {
      const cadence = document.getElementById('cadence').value;
      const severity = document.getElementById('severity').value;
      const confidence = document.getElementById('confidence').value;
      const autofixPrs = document.getElementById('autofixPrs').checked;

      // Get disabled tools (unchecked checkboxes)
      const allTools = document.querySelectorAll('input[name="tool"]');
      const disabledTools = [];
      allTools.forEach(cb => {
        if (!cb.checked) {
          disabledTools.push(cb.value);
        }
      });

      return { cadence, severity, confidence, disabledTools, autofixPrs };
    }

    const form = document.getElementById('installForm');
    const repoInput = document.getElementById('repo');
    const errorEl = document.getElementById('error');
    const submitBtn = document.getElementById('submitBtn');
    const updateBtn = document.getElementById('updateBtn');
    const copyNotice = document.getElementById('copyNotice');

    // Cache for default branches to avoid repeated API calls
    const branchCache = new Map();

    // Fetch the default branch for a repository
    async function getDefaultBranch(repo) {
      if (branchCache.has(repo)) {
        return branchCache.get(repo);
      }

      try {
        const response = await fetch(`https://api.github.com/repos/${repo}`);
        if (response.ok) {
          const data = await response.json();
          const branch = data.default_branch || 'main';
          branchCache.set(repo, branch);
          return branch;
        }
      } catch (err) {
        console.warn('Could not fetch default branch, using main:', err);
      }

      // Fallback to main if API fails
      return 'main';
    }

    // Extract owner/repo from various input formats
    function parseRepo(input) {
      const trimmed = input.trim();

      // Try to match GitHub URL formats
      const urlMatch = trimmed.match(/(?:https?:\/\/)?github\.com\/([a-zA-Z0-9_.-]+)\/([a-zA-Z0-9_.-]+)/);
      if (urlMatch) {
        return `${urlMatch[1]}/${urlMatch[2]}`;
      }

      // Try owner/repo format
      const simpleMatch = trimmed.match(/^([a-zA-Z0-9_.-]+)\/([a-zA-Z0-9_.-]+)$/);
      if (simpleMatch) {
        return trimmed;
      }

      return null;
    }

    // Validate on input
    repoInput.addEventListener('input', () => {
      const repo = parseRepo(repoInput.value);
      const valid = repo !== null;
      errorEl.classList.toggle('show', repoInput.value && !valid);
      submitBtn.disabled = repoInput.value && !valid;
      updateBtn.disabled = repoInput.value && !valid;
    });

    // Check if any options are customized
    function updateCustomIndicator() {
      const options = getOptions();
      const isCustom =
        options.cadence !== DEFAULTS.cadence ||
        options.severity !== DEFAULTS.severity ||
        options.confidence !== DEFAULTS.confidence ||
        options.disabledTools.length > 0 ||
        options.autofixPrs !== DEFAULTS.autofixPrs;

      document.getElementById('customIndicator').classList.toggle('show', isCustom);
    }

    // Update indicator when any option changes
    document.querySelectorAll('#advancedOptions select, #advancedOptions input').forEach(el => {
      el.addEventListener('change', updateCustomIndicator);
    });

    // Show copy notification
    function showCopyNotice() {
      copyNotice.classList.add('show');
      setTimeout(() => copyNotice.classList.remove('show'), 3000);
    }

    // Add new workflow file
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const repo = parseRepo(repoInput.value);
      if (!repo) {
        errorEl.classList.add('show');
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = 'Loading...';

      try {
        const branch = await getDefaultBranch(repo);
        const options = getOptions();
        const workflowContent = generateWorkflow(options);
        const encoded = encodeURIComponent(workflowContent);
        const url = `https://github.com/${repo}/new/${branch}?filename=.github/workflows/vibecheck.yml&value=${encoded}`;

        window.location.href = url;
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add to repository';
      }
    });

    // Update existing workflow - copy YAML and open edit page
    updateBtn.addEventListener('click', async () => {
      const repo = parseRepo(repoInput.value);
      if (!repo) {
        errorEl.classList.add('show');
        return;
      }

      // Show loading state
      updateBtn.disabled = true;
      updateBtn.textContent = 'Loading...';

      try {
        const branch = await getDefaultBranch(repo);
        const options = getOptions();
        const workflowContent = generateWorkflow(options);

        // Copy to clipboard
        try {
          await navigator.clipboard.writeText(workflowContent);
          showCopyNotice();
        } catch (err) {
          // Fallback for older browsers
          const textarea = document.createElement('textarea');
          textarea.value = workflowContent;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          showCopyNotice();
        }

        // Open the edit page for the existing file
        const editUrl = `https://github.com/${repo}/edit/${branch}/.github/workflows/vibecheck.yml`;
        window.open(editUrl, '_blank');
      } finally {
        updateBtn.disabled = false;
        updateBtn.textContent = 'Update existing workflow';
      }
    });

  </script>
</body>
</html>
