# vibeCop Reusable Analysis Workflow
#
# This workflow performs static analysis on a repository and:
# - Runs Trunk + optional additional tools
# - Generates SARIF for GitHub Code Scanning
# - Generates LLM JSON for AI agent consumption
# - Creates/updates GitHub Issues for actionable findings
#
# Usage in caller repo:
#   jobs:
#     vibeCop:
#       uses: <OWNER>/vibeCop/.github/workflows/reusable-analyze.yml@main
#       with:
#         cadence: "weekly"
#       secrets:
#         GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: vibeCop Analysis

on:
  workflow_call:
    inputs:
      cadence:
        description: "Analysis cadence: daily, weekly, or monthly"
        required: false
        default: "weekly"
        type: string
      trunk_arguments:
        description: "Arguments to pass to trunk check"
        required: false
        default: "check"
        type: string
      issue_label:
        description: "Label for created issues"
        required: false
        default: "vibeCop"
        type: string
      config_path:
        description: "Path to vibecop.yml config file"
        required: false
        default: "vibecop.yml"
        type: string
      deep_scan:
        description: "Enable all analysis tools regardless of cadence"
        required: false
        default: false
        type: boolean
      skip_issues:
        description: "Skip GitHub issue creation/updates"
        required: false
        default: false
        type: boolean
      severity_threshold:
        description: "Minimum severity for issue creation: critical, high, medium, low, or info (default: all)"
        required: false
        default: "info"
        type: string
      confidence_threshold:
        description: "Minimum confidence for issue creation: high, medium, or low (default: all)"
        required: false
        default: "low"
        type: string
      merge_strategy:
        description: "How to merge findings into issues: none, same-file, same-rule, or same-tool (default: same-rule)"
        required: false
        default: "same-rule"
        type: string
      artifact_retention_days:
        description: "Number of days to retain analysis artifacts"
        required: false
        default: 14
        type: number
    secrets:
      GH_TOKEN:
        description: "GitHub token for issue management and SARIF upload"
        required: true

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  # Check if there are recent changes (skip daily runs on unchanged repos)
  check-changes:
    name: Check for Changes
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for recent commits
        id: check
        run: |
          # For daily cadence, skip if no commits in last 25 hours
          # For weekly/monthly, always run
          if [[ "${{ inputs.cadence }}" == "daily" ]]; then
            SINCE="25 hours ago"
            COMMIT_COUNT=$(git log --oneline --since="$SINCE" | wc -l)
            
            if [[ "$COMMIT_COUNT" -eq 0 ]]; then
              echo "No commits in the last 25 hours, skipping daily analysis"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "Found $COMMIT_COUNT commit(s) in the last 25 hours"
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          else
            # Weekly/monthly runs always execute
            echo "Cadence is ${{ inputs.cadence }}, running analysis"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  analyze:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.has_changes == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout vibeCop
        uses: actions/checkout@v4
        with:
          repository: <OWNER>/vibeCop
          path: .vibecop
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: .vibecop/pnpm-lock.yaml

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install vibeCop dependencies
        run: |
          cd .vibecop
          pnpm install --frozen-lockfile

      - name: Setup Trunk
        uses: trunk-io/trunk-action/setup@v1
        # This installs Trunk CLI without running checks
        # We'll run it ourselves via the analyze script

      - name: Setup Python (for Semgrep)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Analysis
        id: analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          cd ${{ github.workspace }}

          # Run the analysis
          npx tsx .vibecop/scripts/analyze.ts \
            --root "${{ github.workspace }}" \
            --cadence "${{ inputs.cadence }}" \
            --config "${{ inputs.config_path }}" \
            --output "${{ github.workspace }}/.vibecop-output" \
            --severity-threshold "${{ inputs.severity_threshold }}" \
            --confidence-threshold "${{ inputs.confidence_threshold }}" \
            --merge-strategy "${{ inputs.merge_strategy }}" \
            ${{ inputs.skip_issues && '--skip-issues' || '' }}

      - name: Upload SARIF to Code Scanning
        if: always() && hashFiles('.vibecop-output/results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: .vibecop-output/results.sarif
          category: vibeCop

      - name: Upload Analysis Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vibecop-results
          path: |
            .vibecop-output/results.sarif
            .vibecop-output/results.llm.json
            .vibecop-output/findings.json
            .vibecop-output/context.json
          retention-days: ${{ inputs.artifact_retention_days || 14 }}

      - name: Summary
        if: always()
        run: |
          if [ -f ".vibecop-output/results.llm.json" ]; then
            echo "## vibeCop Analysis Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract summary from LLM JSON
            TOTAL=$(jq '.summary.totalFindings' .vibecop-output/results.llm.json)
            ACTIONABLE=$(jq '.summary.actionable' .vibecop-output/results.llm.json)
            HIGH_CONF=$(jq '.summary.highConfidence' .vibecop-output/results.llm.json)

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Findings | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| High Confidence | $HIGH_CONF |" >> $GITHUB_STEP_SUMMARY
            echo "| Actionable | $ACTIONABLE |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "### By Tool" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            jq '.summary.byTool' .vibecop-output/results.llm.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## vibeCop Analysis" >> $GITHUB_STEP_SUMMARY
            echo "No results generated." >> $GITHUB_STEP_SUMMARY
          fi
